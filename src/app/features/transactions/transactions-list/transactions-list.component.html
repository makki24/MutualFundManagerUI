<mat-card class="transactions-container">
  <mat-card-header>
    <mat-card-title>
      {{ viewType === 'portfolio' ? 'Portfolio' : 'User' }} Transactions
      <span class="transaction-count" *ngIf="totalCount > 0">
        ({{ totalCount }} total)
      </span>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <!-- Filters Section -->
    <div class="filters-section">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Transaction Type</mat-label>
        <mat-select [(ngModel)]="selectedType">
          <mat-option>All Types</mat-option>
          <mat-option *ngFor="let type of transactionTypes" [value]="type">
            {{ type }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field" *ngIf="viewType === 'portfolio'">
        <mat-label>Symbol</mat-label>
        <input matInput [(ngModel)]="selectedSymbol" placeholder="Enter symbol">
      </mat-form-field>

      <!-- User filter (only for portfolio view) -->
      <mat-form-field appearance="outline" class="filter-field" *ngIf="viewType === 'portfolio' && portfolioUsers.length > 0">
        <mat-label>User</mat-label>
        <mat-select [(ngModel)]="selectedUserId">
          <mat-option [value]="undefined">All Users</mat-option>
          <mat-option *ngFor="let u of portfolioUsers" [value]="u.id">
            {{ u.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()">
          <mat-icon>filter_list</mat-icon>
          Apply Filters
        </button>
        <button mat-button (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      </div>
    </div>

    <!-- Transactions Table with Scroll Container -->
    <div class="table-container" #scrollContainer>
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading transactions...</p>
      </div>

      <table mat-table [dataSource]="transactions" class="transactions-table" *ngIf="!isLoading">
        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let transaction">
            {{ formatDate(transaction.createdAt) }}
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let transaction">
            <mat-chip [color]="getTransactionTypeColor(transaction.transactionType)" selected>
              {{ transaction.transactionType }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Symbol Column -->
        <ng-container matColumnDef="symbol">
          <th mat-header-cell *matHeaderCellDef>Symbol</th>
          <td mat-cell *matCellDef="let transaction">
            {{ transaction.symbol || '-' }}
          </td>
        </ng-container>

        <!-- Quantity Column -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Quantity</th>
          <td mat-cell *matCellDef="let transaction">
            {{ transaction.quantity || transaction.units || '-' }}
          </td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>Price/NAV</th>
          <td mat-cell *matCellDef="let transaction">
            <span *ngIf="transaction.pricePerUnit">₹{{ transaction.pricePerUnit | number:'1.2-2' }}</span>
            <span *ngIf="!transaction.pricePerUnit && transaction.navValue">₹{{ transaction.navValue | number:'1.2-2' }}</span>
            <span *ngIf="!transaction.pricePerUnit && !transaction.navValue">-</span>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let transaction">
            <span [class.positive-amount]="transaction.transactionType === 'BUY' || transaction.transactionType === 'INVESTMENT'"
                  [class.negative-amount]="transaction.transactionType === 'SELL' || transaction.transactionType === 'WITHDRAWAL' || transaction.transactionType === 'FEE'">
              ₹{{ transaction.totalAmount | number:'1.2-2' }}
            </span>
          </td>
        </ng-container>

        <!-- Portfolio Column (only for user view) -->
        <ng-container matColumnDef="portfolio">
          <th mat-header-cell *matHeaderCellDef>Portfolio</th>
          <td mat-cell *matCellDef="let transaction">
            {{ transaction.portfolio?.name || '-' }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <!-- No data row -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
            No transactions found
          </td>
        </tr>
      </table>

      <!-- Loading more indicator -->
      <div *ngIf="isLoadingMore" class="loading-more">
        <mat-spinner diameter="30"></mat-spinner>
        <span>Loading more transactions...</span>
      </div>

      <!-- End of list indicator -->
      <div *ngIf="!hasMorePages && transactions.length > 0 && !isLoadingMore" class="end-of-list">
        <mat-icon>check_circle</mat-icon>
        <span>All transactions loaded</span>
      </div>
    </div>
  </mat-card-content>
</mat-card>
