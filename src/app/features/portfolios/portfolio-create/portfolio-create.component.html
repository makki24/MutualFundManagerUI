<div class="create-portfolio-container">
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>add_circle</mat-icon>
        Create New Portfolio
      </mat-card-title>
      <mat-card-subtitle>Set up a new mutual fund portfolio with initial configuration</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <mat-stepper [linear]="true" #stepper class="portfolio-stepper">
    <!-- Step 1: Basic Information -->
    <mat-step [stepControl]="basicInfoForm" label="Basic Information">
      <form [formGroup]="basicInfoForm" class="step-form">
        <mat-card>
          <mat-card-content>
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Portfolio Name</mat-label>
                <input matInput formControlName="name" placeholder="Enter portfolio name">
                <mat-icon matSuffix>business_center</mat-icon>
                @if (basicInfoForm.get('name')?.hasError('required') && basicInfoForm.get('name')?.touched) {
                  <mat-error>Portfolio name is required</mat-error>
                }
                @if (basicInfoForm.get('name')?.hasError('minlength')) {
                  <mat-error>Portfolio name must be at least 3 characters</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" rows="3" placeholder="Describe the portfolio strategy and objectives"></textarea>
                <mat-icon matSuffix>description</mat-icon>
                @if (basicInfoForm.get('description')?.hasError('maxlength')) {
                  <mat-error>Description cannot exceed 500 characters</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Initial NAV Value</mat-label>
                <input matInput type="number" formControlName="initialNavValue" placeholder="10.0000">
                <span matTextPrefix>₹</span>
                @if (basicInfoForm.get('initialNavValue')?.hasError('required') && basicInfoForm.get('initialNavValue')?.touched) {
                  <mat-error>Initial NAV is required</mat-error>
                }
                @if (basicInfoForm.get('initialNavValue')?.hasError('min')) {
                  <mat-error>NAV must be greater than 0</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="info-card">
              <mat-icon>info</mat-icon>
              <div class="info-content">
                <h4>Portfolio Cash Management</h4>
                <p>Portfolio will start with $0 cash. Cash will be added from initial investments.</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <div class="step-actions">
          <button mat-raised-button color="primary" matStepperNext [disabled]="basicInfoForm.invalid">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 2: Initial Investors -->
    <mat-step [stepControl]="investorsForm" label="Initial Investors">
      <form [formGroup]="investorsForm" class="step-form">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Add Initial Investors</mat-card-title>
            <mat-card-subtitle>Select users and their initial investment amounts</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            @if (isLoadingUsers) {
              <div class="loading-users">
                <mat-spinner diameter="30"></mat-spinner>
                <span>Loading users...</span>
              </div>
            } @else {
              <div class="add-investor-section">
                <div class="form-row two-columns">
                  <mat-form-field appearance="outline">
                    <mat-label>Select User</mat-label>
                    <mat-select [(value)]="selectedUserId">
                      @for (user of availableUsers; track user.id) {
                        <mat-option [value]="user.id">
                          {{ user.firstName }} {{ user.lastName }} ({{ user.username }})
                        </mat-option>
                      }
                    </mat-select>
                    <mat-icon matSuffix>person</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Investment Amount</mat-label>
                    <input matInput type="number" [(ngModel)]="investmentAmount" placeholder="10000">
                    <span matTextPrefix>₹</span>
                  </mat-form-field>
                </div>

                <button mat-raised-button color="accent" (click)="addInvestor()"
                        [disabled]="!selectedUserId || !investmentAmount || investmentAmount <= 0">
                  <mat-icon>add</mat-icon>
                  Add Investor
                </button>
              </div>

              <mat-divider></mat-divider>

              @if (initialInvestors.length > 0) {
                <div class="investors-list">
                  <h4>Initial Investors ({{ initialInvestors.length }})</h4>
                  <div class="investors-table">
                    <table mat-table [dataSource]="initialInvestors" class="full-width">
                      <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef>Investor</th>
                        <td mat-cell *matCellDef="let investor">
                          {{ investor.user.firstName }} {{ investor.user.lastName }}
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="username">
                        <th mat-header-cell *matHeaderCellDef>Username</th>
                        <td mat-cell *matCellDef="let investor">{{ investor.user.username }}</td>
                      </ng-container>

                      <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef>Investment Amount</th>
                        <td mat-cell *matCellDef="let investor">
                          {{ investor.investmentAmount | currency:'INR':'symbol':'1.2-2' }}
                        </td>
                      </ng-container>

                      <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef>Actions</th>
                        <td mat-cell *matCellDef="let investor; let i = index">
                          <button mat-icon-button color="warn" (click)="removeInvestor(i)">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="investorColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: investorColumns;"></tr>
                    </table>
                  </div>

                  <div class="investment-summary">
                    <div class="summary-card">
                      <mat-icon>account_balance_wallet</mat-icon>
                      <div class="summary-info">
                        <span class="label">Total Initial Investment</span>
                        <span class="value">{{ getTotalInvestment() | currency:'INR':'symbol':'1.2-2' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              } @else {
                <div class="no-investors">
                  <mat-icon>people_outline</mat-icon>
                  <p>No investors added yet</p>
                  <small>Add at least one initial investor to continue</small>
                </div>
              }
            }
          </mat-card-content>
        </mat-card>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="initialInvestors.length === 0">
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 3: Review & Create -->
    <mat-step label="Review & Create">
      <div class="step-form">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Review Portfolio Details</mat-card-title>
            <mat-card-subtitle>Please review all information before creating the portfolio</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="review-section">
              <h4>Basic Information</h4>
              <div class="review-grid">
                <div class="review-item">
                  <span class="label">Portfolio Name:</span>
                  <span class="value">{{ basicInfoForm.get('name')?.value }}</span>
                </div>
                <div class="review-item">
                  <span class="label">Description:</span>
                  <span class="value">{{ basicInfoForm.get('description')?.value || 'No description' }}</span>
                </div>
                <div class="review-item">
                  <span class="label">Initial NAV:</span>
                  <span class="value">₹{{ basicInfoForm.get('initialNavValue')?.value }}</span>
                </div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="review-section">
              <h4>Initial Investors ({{ initialInvestors.length }})</h4>
              <div class="investors-summary">
                @for (investor of initialInvestors; track investor.userId) {
                  <div class="investor-card">
                    <div class="investor-info">
                      <span class="name">{{ investor.user.firstName }} {{ investor.user.lastName }}</span>
                      <span class="username">{{ investor.user.username }}</span>
                    </div>
                    <span class="amount">{{ investor.investmentAmount | currency:'INR':'symbol':'1.2-2' }}</span>
                  </div>
                }
                <div class="total-investment">
                  <strong>Total: {{ getTotalInvestment() | currency:'INR':'symbol':'1.2-2' }}</strong>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button color="primary" (click)="createPortfolio()" [disabled]="isCreating">
            @if (isCreating) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Creating...</span>
            } @else {
              <ng-container>
                <mat-icon>check</mat-icon>
                <span>Create Portfolio</span>
              </ng-container>
            }
          </button>
        </div>
      </div>
    </mat-step>
  </mat-stepper>
</div>
